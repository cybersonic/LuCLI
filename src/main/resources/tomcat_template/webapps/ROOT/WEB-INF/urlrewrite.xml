<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE urlrewrite PUBLIC "-//tuckey.org//DTD UrlRewrite 4.0//EN"
        "http://www.tuckey.org/res/dtds/urlrewrite4.0.dtd">

<!--
    UrlRewriteFilter Configuration for Lucee CFML - Framework-Style Routing
    
    This configuration enables framework-style routing where URLs are routed through
    a central router file (default: index.cfm) which can parse PATH_INFO and handle
    routing internally.
    
    For example: /hello is routed to /index.cfm/hello with PATH_INFO set to /hello
    
    Documentation: https://tuckey.org/urlrewrite/
-->
<urlrewrite>

    <!-- 
        Rule 1: Framework-Style Router
        Routes all requests through the configured router file (e.g., index.cfm)
        This allows the application to parse PATH_INFO and handle routing internally.
        
        Example: /hello -> /index.cfm/hello (PATH_INFO = /hello)
                 /api/users/123 -> /index.cfm/api/users/123 (PATH_INFO = /api/users/123)
    -->
    <rule>
        <name>Framework Router</name>
        <note>
            Routes all requests through the router file for framework-style routing.
            The router file can parse PATH_INFO to determine which controller/view to load.
        </note>
        
        <!-- CRITICAL: Prevent infinite loop by excluding URLs already routed through the router file -->
        <condition type="request-uri" operator="notequal">^/${routerFile}/.*$</condition>
        
        <!-- CRITICAL: Don't rewrite if accessing the router file directly -->
        <condition type="request-uri" operator="notequal">^/${routerFile}$</condition>
        
        <!-- Exclude static resources (images, CSS, JS, fonts, etc.) -->
        <condition type="request-uri" operator="notequal">^/(images|css|js|fonts|assets|static)/.*$</condition>
        
        <!-- Exclude files with common static extensions -->
        <condition type="request-uri" operator="notequal">\.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|pdf|zip|json|xml|txt|map)$</condition>
        
        <!-- Exclude Lucee admin paths - improved pattern -->
        <condition type="request-uri" operator="notequal">^/lucee.*$</condition>
        
        <!-- Exclude REST API paths (if you have a separate REST handler) -->
        <condition type="request-uri" operator="notequal">^/rest/.*$</condition>
        
        <!-- Don't route if the request is already for a .cfm or .cfc file -->
        <condition type="request-uri" operator="notequal">\.(cfm|cfc|cfml)$</condition>
        
        <!-- Don't route if the path maps to a real file or directory -->
        <condition type="request-filename" operator="notfile"/>
        <condition type="request-filename" operator="notdir"/>
        
        <!-- Route everything else through the router file -->
        <from>^/(.*)$</from>
        <to type="forward">/${routerFile}/$1</to>
    </rule>

    <!-- 
        Rule 2: Root Index
        Routes the root path to the router file
    -->
    <rule>
        <name>Root Index</name>
        <note>
            Routes the root path (/) to the router file.
        </note>
        <from>^/$</from>
        <to type="forward">/${routerFile}</to>
    </rule>

    <!--
        Optional: Direct .cfm/.cfc access
        If you need to access specific .cfm files directly (bypassing the router),
        you can add exclusion rules here or in the conditions above.
        
        By default, direct access to .cfm files is allowed and won't be routed.
    -->

</urlrewrite>